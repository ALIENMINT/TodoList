<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>智能清单 Pro - 云同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f4f7f9; touch-action: pan-y; }
        
        /* 布局优化 */
        .user-bar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; padding: 15px 20px; background: rgba(244, 247, 249, 0.8); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; }
        .swiper { width: 100%; padding: 80px 0 40px 0; }
        
        .swiper-slide { 
            background: #fff; border-radius: 28px; width: 85%; max-width: 420px; height: 70vh; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden; display: flex; flex-direction: column;
        }
        .swiper-slide-active { transform: scale(1.02); z-index: 20; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); }
        
        /* 颜色逻辑更新 */
        .card-header { padding: 20px; color: white; transition: background 0.4s ease; }
        .header-past { background: #94a3b8; }    /* 过去：灰色 */
        .header-today { background: #10b981; }   /* 今天：绿色 (已改) */
        .header-future { background: #3b82f6; }  /* 未来：蓝色 */
        .header-has-once { background: #ef4444 !important; } /* 拥有一次性任务：红色 (新增) */
        
        .task-list-container { flex: 1; overflow-y: auto; padding: 15px; }
        .task-item { 
            background: white; border-radius: 12px; margin-bottom: 8px; padding: 12px;
            display: flex; items-center; gap: 12px; border: 1px solid #f1f5f9;
            cursor: grab; transition: background 0.2s;
        }
        .task-item:active { cursor: grabbing; background: #f8fafc; }
        
        .checkbox-custom { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
        .checkbox-custom.checked { background: #10b981; border-color: #10b981; }
        .checkbox-custom i { color: white; font-size: 10px; display: none; }
        .checkbox-custom.checked i { display: block; }
        
        #input-modal { display: none; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); z-index: 100; }

        /* 日期选择器样式优化 */
        #jump-date { border: none; background: #e2e8f0; border-radius: 10px; padding: 5px 10px; font-size: 12px; font-weight: 600; outline: none; }
    </style>
</head>
<body>

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-3xl shadow-xl max-w-sm w-full text-center">
            <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-6">
                <i class="fas fa-cloud"></i>
            </div>
            <h2 class="text-3xl font-bold mb-2">云端清单</h2>
            <p class="text-slate-400 mb-8 text-sm">随时随地同步您的任务</p>
            <button onclick="login()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3">
                <i class="fab fa-google"></i> Google 账号登录
            </button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="user-bar">
            <div class="flex items-center gap-3">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full border-2 border-white shadow-sm">
                <span id="user-name" class="text-sm font-bold text-slate-700">加载中...</span>
            </div>
            <div class="flex items-center gap-3">
                <input type="date" id="jump-date" onchange="jumpToDate(this.value)">
                <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="swiper mySwiper">
            <div class="swiper-wrapper" id="card-wrapper"></div>
        </div>
        <button onclick="openModal()" class="fab"><i class="fas fa-plus"></i></button>
    </div>

    <div id="input-modal" class="fixed inset-0 z-[110] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-6 text-slate-800">新任务</h3>
            <input type="text" id="task-input" placeholder="写点什么..." class="w-full bg-slate-50 p-4 rounded-2xl outline-none mb-6 border-2 border-transparent focus:border-blue-500">
            <div class="flex gap-2 mb-8">
                <label class="flex-1 cursor-pointer"><input type="radio" name="tType" value="once" checked class="hidden peer"><div class="text-center py-2 rounded-xl bg-slate-100 peer-checked:bg-red-500 peer-checked:text-white text-xs font-bold transition-all">一次性</div></label>
                <label class="flex-1 cursor-pointer"><input type="radio" name="tType" value="daily" class="hidden peer"><div class="text-center py-2 rounded-xl bg-slate-100 peer-checked:bg-blue-600 peer-checked:text-white text-xs font-bold transition-all">每日</div></label>
                <label class="flex-1 cursor-pointer"><input type="radio" name="tType" value="weekly" class="hidden peer"><div class="text-center py-2 rounded-xl bg-slate-100 peer-checked:bg-blue-600 peer-checked:text-white text-xs font-bold transition-all">每周</div></label>
            </div>
            <div class="flex gap-4">
                <button onclick="closeModal()" class="flex-1 text-slate-400 font-bold">取消</button>
                <button onclick="addTask()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200">添加任务</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 配置 (保持不变)
        const firebaseConfig = {
            apiKey: "AIzaSyAY2JHi7EK-w2J-or7L28geJfnhQRj51cw",
            authDomain: "mytodoapp-8e830.firebaseapp.com",
            projectId: "mytodoapp-8e830",
            storageBucket: "mytodoapp-8e830.firebasestorage.app",
            messagingSenderId: "484535488942",
            appId: "1:484535488942:web:01f66d0da5bc2da6b9f83f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null, swiper = null, allTasks = [];
        const todayStr = new Date().toISOString().split('T')[0];
        
        // 生成日期范围 (前后各30天以支持跳转)
        const cardDates = [];
        for(let i = -30; i <= 60; i++) {
            const d = new Date(); d.setDate(d.getDate() + i);
            cardDates.push(d.toISOString().split('T')[0]);
        }

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());
        window.openModal = () => document.getElementById('input-modal').style.display = 'flex';
        window.closeModal = () => document.getElementById('input-modal').style.display = 'none';

        // 日期跳转功能
        window.jumpToDate = (selectedDate) => {
            const index = cardDates.indexOf(selectedDate);
            if (index !== -1 && swiper) {
                swiper.slideTo(index);
            } else {
                alert("日期超出范围 (仅支持未来60天内)");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-avatar').src = user.photoURL;
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                initApp();
            }
        });

        function initApp() {
            const wrapper = document.getElementById('card-wrapper');
            wrapper.innerHTML = cardDates.map(date => `
                <div class="swiper-slide" data-date="${date}">
                    <div id="header-${date}" class="card-header header-future">
                        <div class="text-[10px] opacity-70 font-bold tracking-widest uppercase">${date === todayStr ? 'TODAY' : 'DATE'}</div>
                        <div class="text-xl font-bold">${date}</div>
                    </div>
                    <div id="list-${date}" class="task-list-container"></div>
                </div>
            `).join('');

            // 初始化 Swiper
            const todayIndex = cardDates.indexOf(todayStr);
            swiper = new Swiper(".mySwiper", {
                effect: "coverflow", centeredSlides: true, slidesPerView: "auto",
                initialSlide: todayIndex, coverflowEffect: { rotate: 0, depth: 100, modifier: 2.5 },
                on: { slideChange: renderAllCards }
            });

            const q = query(collection(db, "users", currentUser.uid, "tasks"), orderBy("order", "asc"));
            onSnapshot(q, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllCards();
            });
        }

        window.addTask = async () => {
            const text = document.getElementById('task-input').value;
            const type = document.querySelector('input[name="tType"]:checked').value;
            const date = cardDates[swiper.activeIndex];
            if (!text) return;
            
            await addDoc(collection(db, "users", currentUser.uid, "tasks"), {
                text, type, targetDate: date, completedDates: [], order: Date.now(), createdAt: Date.now()
            });
            document.getElementById('task-input').value = "";
            closeModal();
        };

        window.toggleTask = async (id, date) => {
            const task = allTasks.find(t => t.id === id);
            let dates = [...(task.completedDates || [])];
            const idx = dates.indexOf(date);
            if (idx > -1) dates.splice(idx, 1); else dates.push(date);
            await updateDoc(doc(db, "users", currentUser.uid, "tasks", id), { completedDates: dates });
        };

        function renderAllCards() {
            cardDates.forEach(date => {
                const container = document.getElementById(`list-${date}`);
                const header = document.getElementById(`header-${date}`);
                if (!container || !header) return;

                // 筛选该日期的任务
                const dayTasks = allTasks.filter(t => {
                    return t.type === 'once' ? date <= t.targetDate : date >= t.targetDate;
                });

                // --- 逻辑：更新顶部颜色 ---
                let colorClass = "header-future";
                if (date < todayStr) colorClass = "header-past";
                else if (date === todayStr) colorClass = "header-today";

                // 如果当天有“一次性任务”，强制显示红色
                const hasOnceTask = dayTasks.some(t => t.type === 'once');
                if (hasOnceTask) {
                    header.className = `card-header header-has-once`;
                } else {
                    header.className = `card-header ${colorClass}`;
                }

                container.innerHTML = dayTasks.map(t => {
                    const done = t.completedDates?.includes(date);
                    return `
                        <div class="task-item" data-id="${t.id}">
                            <div class="checkbox-custom ${done ? 'checked' : ''}" onclick="event.stopPropagation(); toggleTask('${t.id}', '${date}')">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm ${done ? 'line-through text-slate-300' : 'text-slate-700 font-medium'}">
                                    ${t.type === 'once' ? '<span class="text-red-500 mr-1">●</span>' : ''}${t.text}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');

                // 拖拽排序逻辑 (保持不变)
                new Sortable(container, {
                    animation: 150, delay: 200, delayOnTouchOnly: true,
                    onEnd: async (evt) => {
                        const batch = writeBatch(db);
                        Array.from(evt.to.children).forEach((el, index) => {
                            const taskId = el.getAttribute('data-id');
                            batch.update(doc(db, "users", currentUser.uid, "tasks", taskId), { order: index });
                        });
                        await batch.commit();
                    }
                });
            });
        }
    </script>
</body>
</html>
