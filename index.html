<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>智能清单 Pro - 精准逻辑版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f4f7f9; touch-action: pan-y; }
        
        .user-bar { position: fixed; top: 0; left: 0; right: 0; z-index: 100; padding: 12px 20px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .swiper { width: 100%; padding: 80px 0 40px 0; }
        
        .swiper-slide { 
            background: #fff; border-radius: 28px; width: 85%; max-width: 400px; height: 72vh; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: all 0.4s; overflow: hidden; display: flex; flex-direction: column;
        }
        .swiper-slide-active { transform: scale(1.02); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.12); }
        
        /* 状态颜色 */
        .card-header { padding: 20px; color: white; transition: background 0.4s ease; }
        .header-past { background: #cbd5e1; }    /* 过去：淡灰 */
        .header-today { background: #10b981; }   /* 今天：绿色 */
        .header-future { background: #3b82f6; }  /* 未来：蓝色 */
        .header-critical { background: #ef4444 !important; } /* 关键任务日：红色 */
        
        /* 任务行样式 */
        .task-item { 
            background: white; border-radius: 14px; margin-bottom: 10px; padding: 14px;
            display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9;
            transition: all 0.2s;
        }
        /* 禁用状态：灰色、半透明、不可点击 */
        .task-disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; background: #f8fafc; border-style: dashed; }
        
        .checkbox-custom { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
        .checkbox-custom.checked { background: #10b981; border-color: #10b981; }
        .checkbox-custom i { color: white; font-size: 10px; display: none; }
        .checkbox-custom.checked i { display: block; }
        
        #input-modal { display: none; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4); z-index: 100; }

        /* 时间选择增强 */
        .jump-container { display: flex; align-items: center; background: #f1f5f9; padding: 6px 12px; border-radius: 12px; gap: 8px; color: #64748b; font-size: 12px; font-weight: 600; cursor: pointer; }
        #jump-date { border: none; background: transparent; font-family: inherit; outline: none; cursor: pointer; color: #1e293b; }
    </style>
</head>
<body>

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-3xl shadow-xl max-w-sm w-full text-center">
            <h2 class="text-3xl font-bold mb-8 text-slate-800">云端清单 Pro</h2>
            <button onclick="login()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">Google 登录</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="user-bar">
            <div class="flex items-center gap-2">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-slate-200">
                <span id="user-name" class="text-xs font-bold text-slate-600 truncate max-w-[80px]">...</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="jump-container">
                    <i class="far fa-calendar-alt"></i>
                    <span>跳转至</span>
                    <input type="date" id="jump-date" onchange="jumpToDate(this.value)">
                </div>
                <button onclick="logout()" class="w-8 h-8 flex items-center justify-center text-slate-400"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <div class="swiper mySwiper">
            <div class="swiper-wrapper" id="card-wrapper"></div>
        </div>
        <button onclick="openModal()" class="fab"><i class="fas fa-plus"></i></button>
    </div>

    <div id="input-modal" class="fixed inset-0 z-[110] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-6 text-slate-800">添加新计划</h3>
            <input type="text" id="task-input" placeholder="输入任务内容..." class="w-full bg-slate-50 p-4 rounded-2xl outline-none mb-6 border-2 border-transparent focus:border-blue-500">
            <div class="flex gap-2 mb-8">
                <label class="flex-1 cursor-pointer"><input type="radio" name="tType" value="once" checked class="hidden peer"><div class="text-center py-2 rounded-xl bg-slate-100 peer-checked:bg-red-500 peer-checked:text-white text-xs font-bold transition-all">一次性</div></label>
                <label class="flex-1 cursor-pointer"><input type="radio" name="tType" value="daily" class="hidden peer"><div class="text-center py-2 rounded-xl bg-slate-100 peer-checked:bg-green-600 peer-checked:text-white text-xs font-bold transition-all">每日</div></label>
                <label class="flex-1 cursor-pointer"><input type="radio" name="tType" value="weekly" class="hidden peer"><div class="text-center py-2 rounded-xl bg-slate-100 peer-checked:bg-blue-600 peer-checked:text-white text-xs font-bold transition-all">每周</div></label>
            </div>
            <div class="flex gap-4">
                <button onclick="closeModal()" class="flex-1 text-slate-400 font-bold">取消</button>
                <button onclick="addTask()" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold">确认添加</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAY2JHi7EK-w2J-or7L28geJfnhQRj51cw",
            authDomain: "mytodoapp-8e830.firebaseapp.com",
            projectId: "mytodoapp-8e830",
            storageBucket: "mytodoapp-8e830.firebasestorage.app",
            messagingSenderId: "484535488942",
            appId: "1:484535488942:web:01f66d0da5bc2da6b9f83f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null, swiper = null, allTasks = [];
        const todayStr = new Date().toISOString().split('T')[0];
        
        // 生成 120 天范围
        const cardDates = [];
        for(let i = -30; i <= 90; i++) {
            const d = new Date(); d.setDate(d.getDate() + i);
            cardDates.push(d.toISOString().split('T')[0]);
        }

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());
        window.openModal = () => {
            document.getElementById('input-modal').style.display = 'flex';
            document.getElementById('task-input').focus();
        };
        window.closeModal = () => document.getElementById('input-modal').style.display = 'none';
        window.jumpToDate = (val) => {
            const idx = cardDates.indexOf(val);
            if(idx !== -1) swiper.slideTo(idx);
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-avatar').src = user.photoURL;
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                initApp();
            }
        });

        function initApp() {
            const wrapper = document.getElementById('card-wrapper');
            wrapper.innerHTML = cardDates.map(date => `
                <div class="swiper-slide" data-date="${date}">
                    <div id="header-${date}" class="card-header header-future">
                        <div class="text-[10px] opacity-70 font-bold tracking-widest uppercase">
                            ${date === todayStr ? '— TODAY —' : getDayName(date)}
                        </div>
                        <div class="text-xl font-bold">${date}</div>
                    </div>
                    <div id="list-${date}" class="task-list-container"></div>
                </div>
            `).join('');

            swiper = new Swiper(".mySwiper", {
                effect: "coverflow", centeredSlides: true, slidesPerView: "auto",
                initialSlide: cardDates.indexOf(todayStr),
                coverflowEffect: { rotate: 0, depth: 100, modifier: 2.5 },
                on: { slideChange: renderAllCards }
            });

            onSnapshot(query(collection(db, "users", currentUser.uid, "tasks"), orderBy("order", "asc")), (snap) => {
                allTasks = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllCards();
            });
        }

        function getDayName(dateStr) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[new Date(dateStr).getDay()];
        }

        window.addTask = async () => {
            const text = document.getElementById('task-input').value;
            const type = document.querySelector('input[name="tType"]:checked').value;
            const date = cardDates[swiper.activeIndex];
            if (!text) return;
            await addDoc(collection(db, "users", currentUser.uid, "tasks"), {
                text, type, targetDate: date, completedDates: [], order: Date.now()
            });
            document.getElementById('task-input').value = "";
            closeModal();
        };

        window.toggleTask = async (id, date) => {
            const task = allTasks.find(t => t.id === id);
            let dates = [...(task.completedDates || [])];
            const idx = dates.indexOf(date);
            if (idx > -1) dates.splice(idx, 1); else dates.push(date);
            await updateDoc(doc(db, "users", currentUser.uid, "tasks", id), { completedDates: dates });
        };

        function renderAllCards() {
            cardDates.forEach(date => {
                const container = document.getElementById(`list-${date}`);
                const header = document.getElementById(`header-${date}`);
                if (!container || !header) return;

                const currentDayOfWeek = new Date(date).getDay();

                // 筛选逻辑：一次性任务提前显示预览，周期任务从起始日后开始显示
                const dayTasks = allTasks.filter(t => {
                    if (t.type === 'once') return date <= t.targetDate; // 提前显示预览
                    return date >= t.targetDate; // 每日和每周从起始日开始
                });

                // --- 逻辑判断核心 ---
                let hasActiveCriticalTask = false;

                const html = dayTasks.map(t => {
                    let isActive = false;
                    if (t.type === 'once') {
                        isActive = (date === t.targetDate);
                    } else if (t.type === 'weekly') {
                        const targetDayOfWeek = new Date(t.targetDate).getDay();
                        isActive = (currentDayOfWeek === targetDayOfWeek);
                    } else if (t.type === 'daily') {
                        isActive = true;
                    }

                    if (isActive && (t.type === 'once' || t.type === 'weekly')) {
                        hasActiveCriticalTask = true;
                    }

                    const done = t.completedDates?.includes(date);
                    const disabledClass = !isActive ? 'task-disabled' : '';

                    return `
                        <div class="task-item ${disabledClass}" data-id="${t.id}">
                            <div class="checkbox-custom ${done ? 'checked' : ''}" 
                                 onclick="${isActive ? `toggleTask('${t.id}', '${date}')` : ''}">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm ${done ? 'line-through text-slate-300' : 'text-slate-800 font-semibold'}">
                                    ${t.text}
                                </p>
                                ${!isActive ? `<span class="text-[9px] text-slate-400 font-bold uppercase">锁定 / 预览</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;

                // 刷新顶栏颜色
                let baseColor = "header-future";
                if (date < todayStr) baseColor = "header-past";
                else if (date === todayStr) baseColor = "header-today";

                header.className = `card-header ${hasActiveCriticalTask ? 'header-critical' : baseColor}`;
            });
        }
    </script>
</body>
</html>
