<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ¸…å• Pro - æç®€äº¤äº’ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .checkbox-custom { width: 24px; height: 24px; border: 2px solid #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .checkbox-custom.checked { background-color: #3b82f6; border-color: #3b82f6; }
        .checkbox-custom i { color: white; font-size: 10px; display: none; }
        .checkbox-custom.checked i { display: block; }
        .task-grey { opacity: 0.5; filter: grayscale(0.8); background-color: #f1f5f9 !important; border-style: dashed !important; }
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 600; }
        
        /* åŠ¨ç”»è¿‡æ¸¡ */
        #input-panel { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-height: 0; overflow: hidden; opacity: 0; }
        #input-panel.active { max-height: 200px; opacity: 1; margin-bottom: 2rem; }
    </style>
</head>
<body class="min-h-screen">

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-card p-10 rounded-3xl shadow-2xl max-w-sm w-full text-center border-none">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-100">
                <i class="fas fa-check-circle text-white text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-8">äº‘ç«¯æ™ºèƒ½æ¸…å•</h2>
            <button onclick="login()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all flex items-center justify-center gap-3">
                <img src="https://www.google.com/favicon.ico" class="w-5 h-5 bg-white rounded-full p-0.5">
                Google è´¦å·ç™»å½•
            </button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <nav class="max-w-3xl mx-auto px-6 py-6 flex justify-between items-center">
            <div class="flex flex-col">
                <input type="date" id="date-picker" class="text-xl font-bold text-slate-800 bg-transparent outline-none cursor-pointer border-none p-0">
                <span id="user-display" class="text-[10px] text-slate-400 font-medium tracking-wider uppercase mt-1">åŠ è½½ä¸­...</span>
            </div>
            <button onclick="logout()" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-slate-400 hover:text-red-500 transition-colors border border-slate-100">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </nav>

        <main class="max-w-3xl mx-auto px-4 pb-32">
            
            <button id="add-trigger" onclick="toggleInputPanel()" class="w-full mb-6 bg-white border-2 border-dashed border-slate-200 py-4 rounded-2xl text-slate-400 font-medium hover:border-blue-400 hover:text-blue-500 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-plus-circle"></i>
                <span>æ·»åŠ æ–°ä»»åŠ¡</span>
            </button>

            <div id="input-panel" class="glass-card rounded-2xl p-4 shadow-xl border-blue-100">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="task-input" placeholder="å‡†å¤‡åšä»€ä¹ˆï¼Ÿ" class="flex-1 bg-white px-4 py-3 rounded-xl outline-none border focus:border-blue-500 text-slate-700">
                    <button onclick="addTask()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700">å‘é€</button>
                </div>
                <div class="flex gap-4 px-2">
                    <label class="flex items-center gap-2 cursor-pointer text-xs font-semibold text-slate-500">
                        <input type="radio" name="taskType" value="once" checked class="w-4 h-4"> ä¸€æ¬¡æ€§
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-xs font-semibold text-slate-500">
                        <input type="radio" name="taskType" value="daily" class="w-4 h-4"> æ¯æ—¥
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-xs font-semibold text-slate-500">
                        <input type="radio" name="taskType" value="weekly" class="w-4 h-4"> æ¯å‘¨
                    </label>
                    <button onclick="toggleInputPanel()" class="ml-auto text-slate-400 text-xs hover:underline">å–æ¶ˆ</button>
                </div>
            </div>

            <div id="task-list" class="space-y-4">
                </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase é…ç½® (è¯·ç¡®è®¤æ˜¯å¦éœ€è¦æ›´æ–°ä½ çš„ appId ç­‰ä¿¡æ¯)
        const firebaseConfig = {
            apiKey: "AIzaSyAY2JHi7EK-w2J-or7L28geJfnhQRj51cw",
            authDomain: "mytodoapp-8e830.firebaseapp.com",
            projectId: "mytodoapp-8e830",
            storageBucket: "mytodoapp-8e830.firebasestorage.app",
            messagingSenderId: "484535488942",
            appId: "1:484535488942:web:01f66d0da5bc2da6b9f83f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let selectedDate = new Date().toISOString().split('T')[0];

        // UI çŠ¶æ€åˆ‡æ¢
        window.toggleInputPanel = () => {
            const panel = document.getElementById('input-panel');
            const trigger = document.getElementById('add-trigger');
            panel.classList.toggle('active');
            if(panel.classList.contains('active')) {
                document.getElementById('task-input').focus();
                trigger.classList.add('hidden');
            } else {
                trigger.classList.remove('hidden');
            }
        };

        // æ ¸å¿ƒé€»è¾‘ä¿æŒ
        const datePicker = document.getElementById('date-picker');
        datePicker.value = selectedDate;
        datePicker.addEventListener('change', (e) => { selectedDate = e.target.value; initData(); });

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').innerText = user.email.split('@')[0];
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                initData();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        function initData() {
            const q = query(collection(db, "users", currentUser.uid, "tasks"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render(allTasks);
            });
        }

        window.addTask = async () => {
            const input = document.getElementById('task-input');
            const type = document.querySelector('input[name="taskType"]:checked').value;
            if (!input.value.trim()) return;

            await addDoc(collection(db, "users", currentUser.uid, "tasks"), {
                text: input.value,
                type: type, 
                targetDate: selectedDate, 
                completedDates: [], 
                createdAt: Date.now()
            });
            input.value = "";
            toggleInputPanel(); // è‡ªåŠ¨å…³é—­é¢æ¿
        };

        window.toggleTask = async (id, completedDates) => {
            const index = completedDates.indexOf(selectedDate);
            if (index > -1) completedDates.splice(index, 1);
            else completedDates.push(selectedDate);
            await updateDoc(doc(db, "users", currentUser.uid, "tasks", id), { completedDates });
        };

        window.deleteTask = async (id) => { if(confirm("ç¡®å®šè¦ç§»é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ")) await deleteDoc(doc(db, "users", currentUser.uid, "tasks", id)); };

        function render(allTasks) {
            const list = document.getElementById('task-list');
            const selTs = new Date(selectedDate).getTime();
            const oneDay = 24 * 60 * 60 * 1000;

            const filtered = allTasks.filter(t => {
                const tarTs = new Date(t.targetDate).getTime();
                if (t.type === 'once') return selTs <= tarTs;
                return selTs >= tarTs;
            });

            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-slate-300">ä»Šå¤©å¾ˆæ¸…çˆ½ï¼Œæ²¡æœ‰ä»»ä½•ä»»åŠ¡</div>`;
                return;
            }

            list.innerHTML = filtered.map(t => {
                const tarTs = new Date(t.targetDate).getTime();
                const isCompleted = t.completedDates && t.completedDates.includes(selectedDate);
                
                let isGrey = false;
                let countdownText = "";
                let typeLabel = "";

                if (t.type === 'once' && selTs < tarTs) {
                    isGrey = true;
                    const diff = Math.ceil((tarTs - selTs) / oneDay);
                    countdownText = `â³ ${diff}å¤©åæˆªæ­¢`;
                    typeLabel = `<span class="badge bg-slate-100 text-slate-400">ä¸€æ¬¡æ€§</span>`;
                } else if (t.type === 'weekly') {
                    const diffDays = Math.floor((selTs - tarTs) / oneDay);
                    const isWeeklyActive = diffDays % 7 === 0;
                    if (!isWeeklyActive) {
                        isGrey = true;
                        countdownText = `ğŸ“… ä¸‹æ¬¡: ${7 - (diffDays % 7)}å¤©å`;
                        typeLabel = `<span class="badge bg-purple-50 text-purple-400">æ¯å‘¨å‘¨æœŸ</span>`;
                    } else {
                        typeLabel = `<span class="badge bg-purple-600 text-white">æ¯å‘¨ä»»åŠ¡</span>`;
                    }
                } else if (t.type === 'daily') {
                    typeLabel = `<span class="badge bg-blue-600 text-white">æ¯æ—¥ä»»åŠ¡</span>`;
                }

                return `
                    <div class="task-item bg-white p-5 rounded-2xl flex items-center justify-between shadow-sm border border-white transition-all ${isGrey ? 'task-grey' : 'hover:shadow-md'}">
                        <div class="flex items-center gap-4 flex-1 ${isGrey ? '' : 'cursor-pointer'}" onclick="${isGrey ? '' : `toggleTask('${t.id}', ${JSON.stringify(t.completedDates || [])})`}">
                            <div class="checkbox-custom ${isCompleted ? 'checked' : ''}">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <div class="${isCompleted ? 'text-slate-400 line-through' : 'text-slate-700'} font-medium text-lg leading-tight">${t.text}</div>
                                <div class="flex items-center gap-2 mt-1.5">
                                    ${typeLabel} 
                                    <span class="text-[10px] text-blue-500 font-bold tracking-wide">${countdownText}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteTask('${t.id}')" class="text-slate-200 hover:text-red-400 p-2 transition-colors"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
